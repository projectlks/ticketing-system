// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// generator client {
//   provider = "prisma-client-js"
// }

// schema.prisma

generator client {
  provider   = "prisma-client"
  engineType = "binary" // üî• IMPORTANT
  output     = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ======================
// Enums
// ======================
enum Role {
  REQUESTER
  AGENT
  ADMIN
  SUPER_ADMIN
}

enum Priority {
  REQUEST
  MINOR
  MAJOR
  CRITICAL
}

enum Status {
  NEW
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  CANCELED
}

enum Severity {
  INFORMATION
  WARNING
  AVERAGE
  HIGH
  DISASTER
}

// prisma/schema.prisma

// model ZabbixTicket {
//   id        Int      @id @default(autoincrement())
//   eventid   String   @unique
//   name      String
//   status    String
//   clock     DateTime
//   createdAt DateTime @default(now())
// }

model ZabbixTicket {
  id      Int      @id @default(autoincrement())
  eventid String   @unique
  name    String
  status  String
  clock   DateTime

  // New useful fields
  triggerId       String?
  triggerName     String?
  triggerDesc     String?
  triggerStatus   String?
  triggerSeverity String?

  hostName  String?
  hostTag   String? // inventory tag from host
  hostGroup String? // comma separated host groups

  itemId          String?
  itemName        String?
  itemDescription String?
  last5Values     String? // Save as multiline string
  tags            String? // comma-separated "key:value"

  // emailSent Boolean @default(false)

  acknowledgedAt DateTime?
  acknowledgedBy String?

  createdAt DateTime @default(now())
}

// ======================
// User model
// ======================
model User {
  id       String @id @default(cuid())
  name     String
  email    String @unique
  password String
  role     Role   @default(REQUESTER)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isArchived Boolean  @default(false)
  profileUrl String?

  // Relations: created/updated users
  creatorId    String?
  creator      User?   @relation("CreatedUsers", fields: [creatorId], references: [id])
  updaterId    String?
  updater      User?   @relation("UpdatedUsers", fields: [updaterId], references: [id])
  createdUsers User[]  @relation("CreatedUsers")
  updatedUsers User[]  @relation("UpdatedUsers")

  // Departments
  createdDepartments Department[] @relation("DepartmentCreators")
  updatedDepartments Department[] @relation("DepartmentUpdaters")

  departmentId String
  department   Department? @relation(fields: [departmentId], references: [id])

  // Job Positions
  jobPositionId String?

  // Tickets
  requestTickets  Ticket[]      @relation("TicketRequester")
  assignedTickets Ticket[]      @relation("TicketAssignedTo")
  likes           CommentLike[]

  //  likes           CommentLike[]

  // Audits & Comments
  audits   Audit[]
  comments Comment[]
  views    TicketView[]
}

// ======================
// Department model
// ======================
model Department {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  contact     String?
  email       String?

  creatorId String?
  creator   User?   @relation("DepartmentCreators", fields: [creatorId], references: [id])

  updaterId String?
  updater   User?   @relation("DepartmentUpdaters", fields: [updaterId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tickets    Ticket[]   @relation("DepartmentTickets")
  // categories Category[]
  users      User[] // all users in this department
  categories Category[]

  @@map("department")
}

// ======================
// Ticket model
// ======================
model Ticket {
  id          String @id @default(cuid())
  ticketId    String @map("ticket_id")
  title       String @db.VarChar(100)
  description String

  departmentId String?
  department   Department? @relation("DepartmentTickets", fields: [departmentId], references: [id])

  requesterId String
  requester   User   @relation("TicketRequester", fields: [requesterId], references: [id])

  status Status @default(NEW)

  assignedToId String?
  assignedTo   User?   @relation("TicketAssignedTo", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  attached  String?

  priority   Priority?
  isArchived Boolean   @default(false)

  images   TicketImage[]
  comments Comment[]
  views    TicketView[]

  // Sla tesitng

  slaId String?
  sla   SLA?    @relation(fields: [slaId], references: [id])

  categoryId String?
  category   Category? @relation("CategoryTickets", fields: [categoryId], references: [id])

  remark String?

  // ‚úÖ SLA Violation tracking
  isSlaViolated Boolean @default(false)

  startSlaTime  DateTime?
  responseDue   DateTime?
  resolutionDue DateTime?
  // category      Category? @relation(fields: [categoryId], references: [id])
  // categoryId    String?

  @@index([departmentId])
  @@index([assignedToId])
}

// SLA

model SLA {
  id             String   @id @default(uuid())
  priority       String   @unique
  responseTime   Int // minutes
  resolutionTime Int // minutes
  rcaTime        Int?
  availability   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  Ticket         Ticket[]
}

// ======================
// TicketImage model
// ======================
model TicketImage {
  id       String @id @default(cuid())
  url      String
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model TicketView {
  id       String   @id @default(cuid())
  ticketId String
  userId   String
  viewedAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@unique([ticketId, userId]) // ·Äê·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Äº·Ä≠·Äô·Ä∫·Äê·ÄÅ·Ä´·Äë·ÄÄ·Ä∫·Äô·Äô·Äº·Ä±·Ä¨·ÄÄ·Ä∫·Äî·Ä±·Äõ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ unique ·Äë·Ä¨·Ä∏
}

// ======================
// Comment model
// ======================
model Comment {
  id       String  @id @default(cuid())
  content  String?
  imageUrl String?

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  commenterId String
  commenter   User   @relation(fields: [commenterId], references: [id])

  parentId String?
  parent   Comment?  @relation("CommentToSubComments", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentToSubComments")

  likes     CommentLike[]
  createdAt DateTime      @default(now())
}

// ======================
// CommentLike model
// ======================
model CommentLike {
  id        String  @id @default(cuid())
  commentId String
  comment   Comment @relation(fields: [commentId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([commentId, userId])
}

// ======================
// Audit model
// ======================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// model Audit {
//   id        String   @id @default(cuid())
//   changedAt DateTime @default(now())

//   entity   String
//   entityId String

//   field    String
//   oldValue String?
//   newValue String?

//   userId String
//   user   User   @relation(fields: [userId], references: [id])

//   action AuditAction // üëà this is the mode you want

//   @@index([entity, entityId])
//   @@index([changedAt])
//   @@map("audit")
// }

model Audit {
  id        String   @id @default(cuid())
  changedAt DateTime @default(now())

  entity   String
  entityId String

  userId String
  user   User   @relation(fields: [userId], references: [id])

  action AuditAction

  changes Json? // <-- store multiple field changes here

  @@index([entity, entityId])
  @@index([changedAt])
  @@map("audit")
}

// { field: "title", oldValue: "Old Title", newValue: "New Title" }

model Category {
  id   String @id @default(cuid())
  name String

  // ===== HIGHLIGHT: department relation =====
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parentId      String?
  parent        Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  subcategories Category[] @relation("CategoryHierarchy")

  tickets Ticket[] @relation("CategoryTickets")
  // subTickets Ticket[] @relation("SubcategoryTickets")

  @@map("category")
}

model MailSetting {
  id        String   @id @default(cuid())
  emails    String[] // array of email addresses
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
